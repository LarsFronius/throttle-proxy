#!/usr/bin/env node

var proxy = require('../lib/server.js');
var argv;

/**
 * Check for string
 * @param val
 * @returns {boolean} return false if val is not empty string
 */
function checkString(val) {
	return !(typeof val == 'string' && val.length > 0);
}

/**
 * Check for positive number
 * @param val
 * @returns {boolean} return false if val is not positive number
 */
function checkPositiveNumber(val) {
	return !(typeof val == 'number' && val > 0);
}


argv = require('optimist')
	.usage('Throttle HTTP proxy server')
	.describe('port', 'incoming port number')
	.default('port', 3128)
	.alias('port', 'p')
	.describe('speed', 'throttle incoming data speed to value')
	.default('speed', 100000)
	.alias('speed', 's')
	.describe('outgoing', 'throttle outgoing data speed to value')
	.describe('match', 'throttle requests matching')
	.describe('skip', 'bypass throttling requests matching')
	.string(['match', 'skip'])
	.check(function (config) {

		if (checkPositiveNumber(config)) {
			throw new Error('port must be a number');
		}

		if (checkPositiveNumber(config.speed)) {
			throw new Error('speed must be a number');
		}

		if (typeof config.outgoing != 'undefined' && checkPositiveNumber(config.outgoing)) {
			throw new Error('outgoing speed must be a number');
		}

		if (typeof config.match != 'undefined' && typeof config.skip != 'undefined') {
			throw new Error('simultaneous use of --match and --skip is not allowed');
		}

		if (checkString(config.match)) {
			throw new Error("wrong --match pattern");
		}

		if (checkString(config.skip)) {
			throw new Error("wrong --skip pattern");
		}

		return true;
	})
	.argv;

var pattern, skip;

if (typeof argv.match != 'undefined') {
	pattern = argv.match;
	skip = false;
} else {
	pattern = argv.skip;
	skip = true;
}

proxy(config.speed, config.outgoing, pattern, skip)
  .listen(config.port, function () {
    console.log("Proxy server started on port %d", config.port);
    console.log("Incoming network speed is limited to %d bytes per second", config.speed);
    if (config.outgoing) {
      console.log("Outgoing network speed is limited to %d bytes per second", config.outgoing);
    }
    if (pattern) {
      console.log("%s %s", skip ? "Skipping" : "Matching", pattern);
    } else {
      console.log("For any request");
    }
  });
